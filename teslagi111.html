<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Self Crash Test (Dev Only)</title>
<style>
  body { background:#000; color:#0f0; font-family:monospace; padding:16px }
  #log { white-space:pre-wrap }
</style>
</head>
<body>
<h3>Self Crash Test</h3>
<div id="log"></div>
<script>
const log = (m)=>{ document.getElementById('log').textContent += m + "\n"; };

// HANYA jalan jika ada token dari native (injectedJavaScript)
let authed = false;
function start() {
  if (!window.ReactNativeWebView) return log('No RN WebView');
  if (!authed) return log('Not authed');

  // Beban berat tapi “cepat” → spam paralel + 0ms
  const payload = 'A'.repeat(10_000_000); // 10 juta (≈ cepat dibuat)
  log('Starting spam (0ms, 3 parallel)...');

  // tiga loop paralel untuk “instant overload”
  function loop() {
    window.ReactNativeWebView.postMessage(payload);
    // gunakan requestAnimationFrame untuk steady 60fps
    requestAnimationFrame(loop);
  }
  loop(); loop(); loop();

  // (opsional) versi ekstra brutal:
  // setInterval(()=>window.ReactNativeWebView.postMessage(payload), 0);
}

window.addEventListener('message', (ev) => {
  try {
    const data = ev.data || {};
    if (data.type === 'auth' && data.token && data.token === window.__CRASH_TOKEN) {
      authed = true;
      log('Auth OK. Running test…');
      // Auto-run hanya jika query ?selftest=1
      if (new URLSearchParams(location.search).get('selftest') === '1') {
        start();
      } else {
        log('Query selftest=1 not present; idle.');
      }
    }
  } catch(e) { /* ignore */ }
}, false);

// fallback: kalau injectedJavaScript pakai window.postMessage lama:
setTimeout(()=>{
  if (typeof window.__CRASH_TOKEN === 'string' && !authed) {
    authed = true; // dev fallback
    start();
  }
}, 100);
</script>
</body>
</html>
